<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Quản Lý Người Dùng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='adminstyle.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="sidebar w-64 bg-gray-900 text-white flex flex-col">
      <div class="p-4 text-2xl font-bold border-b border-gray-800">
        <span data-lang-key="admin_dashboard">Admin Dashboard</span>
      </div>
      <nav class="flex-1">
        <a href="#" class="nav-item flex items-center p-4 hover:bg-gray-700 active">
          <i class="fas fa-users mr-2"></i> <span data-lang-key="manage_users">Quản Lý Người Dùng</span>
        </a>
        <a href="#" id="settingsBtn" class="nav-item flex items-center p-4 hover:bg-gray-700">
          <i class="fas fa-cog mr-2"></i> <span data-lang-key="settings">Cài Đặt</span>
        </a>
        <a href="#" id="logoutBtn" class="nav-item flex items-center p-4 hover:bg-gray-700">
          <i class="fas fa-sign-out-alt mr-2"></i> <span data-lang-key="logout">Đăng Xuất</span>
        </a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8 bg-gradient-to-br from-gray-50 to-white">
      <!-- Header Section -->
      <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4 sm:gap-6">
        <div>
          <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight" data-lang-key="manage_users">
            Quản Lý Người Dùng
          </h1>
          <p id="userCount" class="text-lg font-semibold text-gray-600"></p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="relative">
            <input
              id="searchInput"
              type="text"
              class="search-input w-full sm:w-64 p-3 pl-10 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white shadow-sm"
              data-lang-key-placeholder="search_placeholder"
              placeholder="Tìm kiếm theo tên người dùng..."
            />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
          <button
            id="refreshBtn"
            class="add-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg hover:shadow-xl transition-all"
          >
            <i class="fas fa-sync-alt mr-2"></i> <span data-lang-key="refresh">Làm mới</span>
          </button>
        </div>
      </div>

      <!-- User Table -->
      <div class="table-container bg-white rounded-xl shadow-lg overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-sm">
              <th class="py-4 px-6 text-left" data-lang-key="id">ID</th>
              <th class="py-4 px-6 text-left" data-lang-key="username">Tên Người Dùng</th>
              <th class="py-4 px-6 text-left" data-lang-key="role">Vai Trò</th>
              <th class="py-4 px-6 text-center" data-lang-key="actions">Hành Động</th>
            </tr>
          </thead>
          <tbody id="userTable" class="text-gray-600 text-sm"></tbody>
        </table>
        <div class="flex justify-between items-center p-4">
          <button id="prevPageBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50" disabled>
            <span data-lang-key="previous">Trước</span>
          </button>
          <span id="pageInfo" class="text-gray-600"></span>
          <button id="nextPageBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50" disabled>
            <span data-lang-key="next">Tiếp</span>
          </button>
        </div>
      </div>

      <!-- Sensor Data Section -->
      <div id="sensorDataSection" class="table-container bg-white rounded-xl shadow-lg mt-8" style="display: none;">
        <h2 class="text-2xl font-bold p-6 text-gray-800">
          <span data-lang-key="sensor_data_of">Dữ liệu cảm biến của</span> <span id="sensorUsername"></span>
        </h2>
        <div class="p-6">
          <!-- Filter Form -->
          <div class="mb-6 flex flex-col sm:flex-row gap-4">
            <div>
              <label class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="start_date">Từ ngày:</label>
              <input type="datetime-local" id="startDate" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="end_date">Đến ngày:</label>
              <input type="datetime-local" id="endDate" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="filterBtn" class="add-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-xl transition-all mt-6 sm:mt-0">
              <span data-lang-key="filter">Lọc</span>
            </button>
          </div>
          <!-- Chart -->
          <canvas id="adminSensorChart" style="max-height: 300px;"></canvas>
          <div class="input-group mt-4">
            <label for="admin_chart_type" class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="data_type">Loại dữ liệu:</label>
            <select id="admin_chart_type" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updateAdminChart()">
              <option value="temperature" data-lang-key="temperature">Nhiệt độ</option>
              <option value="humidity" data-lang-key="humidity">Độ ẩm không khí</option>
              <option value="soilmoisture" data-lang-key="soilmoisture">Độ ẩm đất</option>
            </select>
          </div>
          <!-- Sensor Data Table -->
          <div class="mt-6">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm">
                  <th class="py-4 px-6 text-left" data-lang-key="timestamp">Thời gian</th>
                  <th class="py-4 px-6 text-left" data-lang-key="temperature">Nhiệt độ (°C)</th>
                  <th class="py-4 px-6 text-left" data-lang-key="humidity">Độ ẩm không khí (%)</th>
                  <th class="py-4 px-6 text-left" data-lang-key="soilmoisture">Độ ẩm đất (%)</th>
                  <th class="py-4 px-6 text-left" data-lang-key="pump_state">Trạng thái bơm</th>
                </tr>
              </thead>
              <tbody id="sensorTable" class="text-gray-600 text-sm"></tbody>
            </table>
            <div class="flex justify-between items-center p-4">
              <button id="prevSensorPageBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50" disabled>
                <span data-lang-key="previous">Trước</span>
              </button>
              <span id="sensorPageInfo" class="text-gray-600"></span>
              <button id="nextSensorPageBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50" disabled>
                <span data-lang-key="next">Tiếp</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for User Details -->
  <div id="userDetailsModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
    <div class="modal-content bg-white p-8 rounded-xl w-full max-w-md shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-gray-800" data-lang-key="user_details">Thông Tin Người Dùng</h2>
      <div class="mb-4">
        <p><strong data-lang-key="id">ID:</strong> <span id="detailId"></span></p>
        <p><strong data-lang-key="username">Tên Người Dùng:</strong> <span id="detailName"></span></p>
        <p><strong data-lang-key="role">Vai Trò:</strong> <span id="detailRole"></span></p>
      </div>
      <div class="flex justify-end">
        <button id="closeDetailsBtn" class="cancel-btn bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">
          <span data-lang-key="close">Đóng</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal for Edit User -->
  <div id="editUserModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
    <div class="modal-content bg-white p-8 rounded-xl w-full max-w-md shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-gray-800" data-lang-key="edit_user">Chỉnh Sửa Người Dùng</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="username">Tên Người Dùng</label>
        <input id="editUsername" type="text" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="role">Vai Trò</label>
        <select id="editRole" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="user" data-lang-key="user">User</option>
          <option value="admin" data-lang-key="admin">Admin</option>
        </select>
      </div>
      <div class="flex justify-end space-x-4">
        <button id="cancelEditBtn" class="cancel-btn bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">
          <span data-lang-key="cancel">Hủy</span>
        </button>
        <button id="saveEditBtn" class="save-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
          <span data-lang-key="save">Lưu</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Confirmation -->
  <div id="deleteModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
    <div class="modal-content bg-white p-8 rounded-xl w-full max-w-sm shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-gray-800" data-lang-key="confirm_delete_user">Xác Nhận Xóa Người Dùng</h2>
      <p class="text-gray-600 mb-6">
        <span data-lang-key="confirm_delete_message">Bạn có chắc chắn muốn xóa người dùng</span> <strong id="deleteUserName"></strong>?
      </p>
      <div class="flex justify-end space-x-4">
        <button id="cancelDeleteBtn" class="cancel-btn bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">
          <span data-lang-key="cancel">Hủy</span>
        </button>
        <button id="confirmDeleteBtn" class="save-btn bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
          <span data-lang-key="delete">Xóa</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal for Settings -->
  <div id="settingsModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
    <div class="modal-content bg-white p-8 rounded-xl w-full max-w-md shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-gray-800" data-lang-key="settings">Cài Đặt</h2>
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="theme">Chế độ giao diện</label>
        <select id="themeSelect" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="light" data-lang-key="light">Sáng</option>
          <option value="dark" data-lang-key="dark">Tối</option>
        </select>
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium mb-2 text-gray-700" data-lang-key="language">Ngôn ngữ</label>
        <select id="languageSelect" class="input-field w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="vi" data-lang-key="vietnamese">Tiếng Việt</option>
          <option value="en" data-lang-key="english">Tiếng Anh</option>
        </select>
      </div>
      <div class="flex justify-end space-x-4">
        <button id="cancelSettingsBtn" class="cancel-btn bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">
          <span data-lang-key="cancel">Hủy</span>
        </button>
        <button id="saveSettingsBtn" class="save-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
          <span data-lang-key="save">Lưu</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal for Logout Confirmation -->
  <div id="logoutModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
    <div class="modal-content bg-white p-8 rounded-xl w-full max-w-sm shadow-2xl">
      <h2 class="text-2xl font-bold mb-6 text-gray-800" data-lang-key="confirm_logout">Xác Nhận Đăng Xuất</h2>
      <p class="text-gray-600 mb-6" data-lang-key="confirm_logout_message">Bạn có chắc chắn muốn đăng xuất?</p>
      <div class="flex justify-end space-x-4">
        <button id="cancelLogoutBtn" class="cancel-btn bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">
          <span data-lang-key="cancel">Hủy</span>
        </button>
        <button id="confirmLogoutBtn" class="save-btn bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
          <span data-lang-key="logout">Đăng Xuất</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Language translations
    const translations = {
      vi: {
        admin_dashboard: "Admin Dashboard",
        manage_users: "Quản Lý Người Dùng",
        settings: "Cài Đặt",
        logout: "Đăng Xuất",
        refresh: "Làm mới",
        search_placeholder: "Tìm kiếm theo tên người dùng...",
        id: "ID",
        username: "Tên Người Dùng",
        role: "Vai Trò",
        actions: "Hành Động",
        sensor_data_of: "Dữ liệu cảm biến của",
        data_type: "Loại dữ liệu",
        temperature: "Nhiệt độ",
        humidity: "Độ ẩm không khí",
        soilmoisture: "Độ ẩm đất",
        user_details: "Thông Tin Người Dùng",
        edit_user: "Chỉnh Sửa Người Dùng",
        confirm_delete_user: "Xác Nhận Xóa Người Dùng",
        confirm_delete_message: "Bạn có chắc chắn muốn xóa người dùng",
        confirm_logout: "Xác Nhận Đăng Xuất",
        confirm_logout_message: "Bạn có chắc chắn muốn đăng xuất?",
        close: "Đóng",
        cancel: "Hủy",
        save: "Lưu",
        delete: "Xóa",
        theme: "Chế độ giao diện",
        language: "Ngôn ngữ",
        light: "Sáng",
        dark: "Tối",
        vietnamese: "Tiếng Việt",
        english: "Tiếng Anh",
        user: "User",
        admin: "Admin",
        previous: "Trước",
        next: "Tiếp",
        total_users: "Tổng số người dùng",
        page: "Trang",
        of: "của",
        start_date: "Từ ngày",
        end_date: "Đến ngày",
        filter: "Lọc",
        timestamp: "Thời gian",
        pump_state: "Trạng thái bơm",
        success: "Thành công",
        error: "Lỗi",
        warning: "Cảnh báo",
        list_refreshed: "Danh sách người dùng đã được làm mới!",
        user_updated: "Cập nhật người dùng thành công!",
        user_deleted: "Xóa người dùng thành công!",
        fill_all_fields: "Vui lòng nhập đầy đủ thông tin.",
        fetch_users_error: "Lỗi khi tải danh sách người dùng.",
        fetch_user_error: "Lỗi khi tải thông tin người dùng.",
        update_user_error: "Lỗi khi cập nhật người dùng.",
        delete_user_error: "Lỗi khi xóa người dùng.",
        fetch_sensor_error: "Lỗi khi tải dữ liệu cảm biến.",
        settings_saved: "Cài đặt đã được lưu!",
        logout_error: "Lỗi khi đăng xuất.",
        invalid_date_range: "Ngày bắt đầu phải trước ngày kết thúc."
      },
      en: {
        admin_dashboard: "Admin Dashboard",
        manage_users: "Manage Users",
        settings: "Settings",
        logout: "Logout",
        refresh: "Refresh",
        search_placeholder: "Search by username...",
        id: "ID",
        username: "Username",
        role: "Role",
        actions: "Actions",
        sensor_data_of: "Sensor data of",
        data_type: "Data type",
        temperature: "Temperature",
        humidity: "Air Humidity",
        soilmoisture: "Soil Moisture",
        user_details: "User Details",
        edit_user: "Edit User",
        confirm_delete_user: "Confirm Delete User",
        confirm_delete_message: "Are you sure you want to delete user",
        confirm_logout: "Confirm Logout",
        confirm_logout_message: "Are you sure you want to logout?",
        close: "Close",
        cancel: "Cancel",
        save: "Save",
        delete: "Delete",
        theme: "Theme",
        language: "Language",
        light: "Light",
        dark: "Dark",
        vietnamese: "Vietnamese",
        english: "English",
        user: "User",
        admin: "Admin",
        previous: "Previous",
        next: "Next",
        total_users: "Total users",
        page: "Page",
        of: "of",
        start_date: "From date",
        end_date: "To date",
        filter: "Filter",
        timestamp: "Timestamp",
        pump_state: "Pump State",
        success: "Success",
        error: "Error",
        warning: "Warning",
        list_refreshed: "User list has been refreshed!",
        user_updated: "User updated successfully!",
        user_deleted: "User deleted successfully!",
        fill_all_fields: "Please fill in all fields.",
        fetch_users_error: "Error fetching user list.",
        fetch_user_error: "Error fetching user details.",
        update_user_error: "Error updating user.",
        delete_user_error: "Error deleting user.",
        fetch_sensor_error: "Error fetching sensor data.",
        settings_saved: "Settings saved!",
        logout_error: "Error logging out.",
        invalid_date_range: "Start date must be before end date."
      }
    };

    // Apply language
    function applyLanguage(lang) {
      document.querySelectorAll("[data-lang-key]").forEach((element) => {
        const key = element.getAttribute("data-lang-key");
        element.textContent = translations[lang][key] || element.textContent;
      });
      document.querySelectorAll("[data-lang-key-placeholder]").forEach((element) => {
        const key = element.getAttribute("data-lang-key-placeholder");
        element.placeholder = translations[lang][key] || element.placeholder;
      });
      document.querySelectorAll("select option").forEach((option) => {
        const key = option.getAttribute("data-lang-key");
        if (key) {
          option.textContent = translations[lang][key] || option.textContent;
        }
      });
      if (adminSensorChart) {
        updateAdminChart();
      }
    }

    // Elements for User Management
    const userTable = document.getElementById("userTable");
    const refreshBtn = document.getElementById("refreshBtn");
    const searchInput = document.getElementById("searchInput");
    const userDetailsModal = document.getElementById("userDetailsModal");
    const closeDetailsBtn = document.getElementById("closeDetailsBtn");
    const detailId = document.getElementById("detailId");
    const detailName = document.getElementById("detailName");
    const detailRole = document.getElementById("detailRole");
    const editUserModal = document.getElementById("editUserModal");
    const editUsername = document.getElementById("editUsername");
    const editRole = document.getElementById("editRole");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const deleteModal = document.getElementById("deleteModal");
    const deleteUserName = document.getElementById("deleteUserName");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    let userIdToEdit = null;
    let userIdToDelete = null;

    // Elements for Pagination (Users)
    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const pageInfo = document.getElementById("pageInfo");
    let currentPage = 1;
    const perPage = 10;

    // Elements for Sensor Data
    let adminSensorChart = null;
    let currentUserId = null;
    let currentSensorPage = 1;
    const sensorPerPage = 50;
    const sensorDataSection = document.getElementById("sensorDataSection");
    const sensorUsername = document.getElementById("sensorUsername");
    const sensorTable = document.getElementById("sensorTable");
    const prevSensorPageBtn = document.getElementById("prevSensorPageBtn");
    const nextSensorPageBtn = document.getElementById("nextSensorPageBtn");
    const sensorPageInfo = document.getElementById("sensorPageInfo");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const filterBtn = document.getElementById("filterBtn");

    // Elements for Settings
    const settingsModal = document.getElementById("settingsModal");
    const settingsBtn = document.getElementById("settingsBtn");
    const cancelSettingsBtn = document.getElementById("cancelSettingsBtn");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const themeSelect = document.getElementById("themeSelect");
    const languageSelect = document.getElementById("languageSelect");

    // Elements for Logout
    const logoutModal = document.getElementById("logoutModal");
    const logoutBtn = document.getElementById("logoutBtn");
    const cancelLogoutBtn = document.getElementById("cancelLogoutBtn");
    const confirmLogoutBtn = document.getElementById("confirmLogoutBtn");

    // User Management Functions
    function renderUsers(users, totalUsers, page) {
      userTable.innerHTML = "";
      users.forEach((user) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="py-4 px-6">${user.id}</td>
          <td class="py-4 px-6">${user.username}</td>
          <td class="py-4 px-6">${user.role}</td>
          <td class="py-4 px-6 text-center space-x-2">
            <button onclick="viewUserDetails(${user.id})" class="text-blue-500 hover:text-blue-700 transition-all">
              <i class="fas fa-eye"></i>
            </button>
            <button onclick="editUser(${user.id})" class="text-yellow-500 hover:text-yellow-700 transition-all">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="viewSensorData(${user.id})" class="text-green-500 hover:text-green-700 transition-all">
              <i class="fas fa-chart-line"></i>
            </button>
            <button onclick="confirmDeleteUser(${user.id}, '${user.username}')" class="text-red-600 hover:text-red-800 transition-all">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        userTable.appendChild(row);
      });
      const lang = languageSelect.value || "vi";
      document.getElementById("userCount").textContent = translations[lang].total_users
        ? `${translations[lang].total_users}: ${totalUsers}`
        : `Tổng số người dùng: ${totalUsers}`;
      const totalPages = Math.ceil(totalUsers / perPage);
      pageInfo.textContent = `${translations[lang].page} ${page} ${translations[lang].of} ${totalPages}`;
      prevPageBtn.disabled = page === 1;
      nextPageBtn.disabled = page === totalPages || totalUsers === 0;
    }

    function fetchUsers(page = 1, query = "") {
      fetch(`/admin/users?page=${page}&per_page=${perPage}&query=${encodeURIComponent(query)}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            Swal.fire({
              icon: "error",
              title: translations[languageSelect.value || "vi"].error,
              text: data.error
            });
          } else {
            renderUsers(data.users, data.total, page);
            currentPage = page;
          }
        })
        .catch((error) => {
          console.error("Lỗi lấy danh sách người dùng:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].fetch_users_error
          });
        });
    }

    function viewUserDetails(id) {
      fetch(`/admin/user/${id}`)
        .then((response) => response.json())
        .then((user) => {
          detailId.textContent = user.id;
          detailName.textContent = user.username;
          detailRole.textContent = user.role;
          userDetailsModal.classList.remove("hidden");
        })
        .catch((error) => {
          console.error("Lỗi lấy chi tiết người dùng:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].fetch_user_error
          });
        });
    }

    function editUser(id) {
      fetch(`/admin/user/${id}`)
        .then((response) => response.json())
        .then((user) => {
          userIdToEdit = id;
          editUsername.value = user.username;
          editRole.value = user.role;
          editUserModal.classList.remove("hidden");
        })
        .catch((error) => {
          console.error("Lỗi lấy thông tin người dùng:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].fetch_user_error
          });
        });
    }

    function saveUserEdit() {
      const username = editUsername.value;
      const role = editRole.value;
      if (username && role) {
        fetch(`/admin/user/${userIdToEdit}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `username=${encodeURIComponent(username)}&role=${encodeURIComponent(role)}`
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              Swal.fire({
                icon: "success",
                title: translations[languageSelect.value || "vi"].success,
                text: translations[languageSelect.value || "vi"].user_updated
              });
              fetchUsers(currentPage);
              editUserModal.classList.add("hidden");
              userIdToEdit = null;
            } else {
              Swal.fire({
                icon: "error",
                title: translations[languageSelect.value || "vi"].error,
                text: data.error
              });
            }
          })
          .catch((error) => {
            console.error("Lỗi cập nhật người dùng:", error);
            Swal.fire({
              icon: "error",
              title: translations[languageSelect.value || "vi"].error,
              text: translations[languageSelect.value || "vi"].update_user_error
            });
          });
      } else {
        Swal.fire({
          icon: "warning",
          title: translations[languageSelect.value || "vi"].warning,
          text: translations[languageSelect.value || "vi"].fill_all_fields
        });
      }
    }

    function confirmDeleteUser(id, name) {
      userIdToDelete = id;
      deleteUserName.textContent = name;
      deleteModal.classList.remove("hidden");
    }

    function deleteUser(id) {
      fetch(`/admin/user/${id}`, {
        method: "DELETE"
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            Swal.fire({
              icon: "success",
              title: translations[languageSelect.value || "vi"].success,
              text: translations[languageSelect.value || "vi"].user_deleted
            });
            fetchUsers(currentPage);
            deleteModal.classList.add("hidden");
            userIdToDelete = null;
          } else {
            Swal.fire({
              icon: "error",
              title: translations[languageSelect.value || "vi"].error,
              text: data.error
            });
          }
        })
        .catch((error) => {
          console.error("Lỗi xóa người dùng:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].delete_user_error
          });
        });
    }

    // Sensor Data Functions
    function viewSensorData(userId) {
      currentUserId = userId;
      fetch(`/admin/user/${userId}`)
        .then((response) => response.json())
        .then((user) => {
          sensorUsername.textContent = user.username;
          sensorDataSection.style.display = "block";
          startDate.value = "";
          endDate.value = "";
          fetchSensorData(1);
        })
        .catch((error) => {
          console.error("Lỗi lấy thông tin người dùng:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].fetch_user_error
          });
        });
    }

    function fetchSensorData(page = 1) {
      if (!currentUserId) return;
      const start = startDate.value ? new Date(startDate.value).toISOString() : "";
      const end = endDate.value ? new Date(endDate.value).toISOString() : "";
      const url = `/admin/sensor_data/${currentUserId}?page=${page}&per_page=${sensorPerPage}` +
                  (start ? `&start_date=${start}` : "") + (end ? `&end_date=${end}` : "");
      
      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            Swal.fire({
              icon: "error",
              title: translations[languageSelect.value || "vi"].error,
              text: data.error
            });
          } else {
            renderSensorData(data.data, data.total, page);
            updateAdminChart();
          }
        })
        .catch((error) => {
          console.error("Lỗi lấy dữ liệu cảm biến:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].fetch_sensor_error
          });
        });
    }

    function renderSensorData(data, total, page) {
      sensorTable.innerHTML = "";
      data.forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="py-4 px-6">${new Date(item.timestamp).toLocaleString("vi-VN")}</td>
          <td class="py-4 px-6">${item.temperature ? item.temperature.toFixed(1) : '-'}</td>
          <td class="py-4 px-6">${item.humidity ? item.humidity.toFixed(1) : '-'}</td>
          <td class="py-4 px-6">${item.soilmoisture ? item.soilmoisture.toFixed(1) : '-'}</td>
          <td class="py-4 px-6">${item.pump_state || '-'}</td>
        `;
        sensorTable.appendChild(row);
      });
      const lang = languageSelect.value || "vi";
      const totalPages = Math.ceil(total / sensorPerPage);
      sensorPageInfo.textContent = `${translations[lang].page} ${page} ${translations[lang].of} ${totalPages}`;
      prevSensorPageBtn.disabled = page === 1;
      nextSensorPageBtn.disabled = page === totalPages || total === 0;
      currentSensorPage = page;
    }

    function updateAdminChart() {
      if (!currentUserId) return;
      const start = startDate.value ? new Date(startDate.value).toISOString() : "";
      const end = endDate.value ? new Date(endDate.value).toISOString() : "";
      const chartType = document.getElementById("admin_chart_type").value;
      const lang = languageSelect.value || "vi";
      const url = `/admin/sensor_data/${currentUserId}?page=1&per_page=${sensorPerPage}` +
                  (start ? `&start_date=${start}` : "") + (end ? `&end_date=${end}` : "");
      
      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          const labels = data.data.map((d) => new Date(d.timestamp).toLocaleString("vi-VN"));
          const values = data.data.map((d) => d[chartType]);
          const unit = chartType === "temperature" ? "°C" : "%";

          if (adminSensorChart) {
            adminSensorChart.destroy();
          }

          adminSensorChart = new Chart(document.getElementById("adminSensorChart"), {
            type: "line",
            data: {
              labels: labels.reverse(),
              datasets: [{
                label: translations[lang][chartType] || chartType,
                data: values.reverse(),
                borderColor: chartType === "temperature" ? "#ff9800" : chartType === "humidity" ? "#2196F3" : "#8d6e63",
                fill: false
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: { title: { display: true, text: translations[lang].time || "Thời gian" } },
                y: { title: { display: true, text: unit } }
              }
            }
          });
        })
        .catch((error) => {
          console.error("Lỗi lấy dữ liệu cảm biến:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].fetch_sensor_error
          });
        });
    }

    // Search Functionality
    searchInput.addEventListener("input", () => {
      const query = searchInput.value.toLowerCase();
      fetchUsers(1, query);
    });

    // Pagination (Users)
    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        fetchUsers(currentPage - 1, searchInput.value);
      }
    });

    nextPageBtn.addEventListener("click", () => {
      fetchUsers(currentPage + 1, searchInput.value);
    });

    // Pagination (Sensor Data)
    prevSensorPageBtn.addEventListener("click", () => {
      if (currentSensorPage > 1) {
        fetchSensorData(currentSensorPage - 1);
      }
    });

    nextSensorPageBtn.addEventListener("click", () => {
      fetchSensorData(currentSensorPage + 1);
    });

    // Filter Button
    filterBtn.addEventListener("click", () => {
      if (startDate.value && endDate.value && new Date(startDate.value) > new Date(endDate.value)) {
        Swal.fire({
          icon: "warning",
          title: translations[languageSelect.value || "vi"].warning,
          text: translations[languageSelect.value || "vi"].invalid_date_range
        });
        return;
      }
      fetchSensorData(1);
    });

    // Refresh Button
    refreshBtn.addEventListener("click", () => {
      searchInput.value = "";
      fetchUsers(1);
      Swal.fire({
        icon: "success",
        title: translations[languageSelect.value || "vi"].success,
        text: translations[languageSelect.value || "vi"].list_refreshed
      });
    });

    // User Details Modal
    closeDetailsBtn.addEventListener("click", () => {
      userDetailsModal.classList.add("hidden");
    });

    // Edit User Modal
    cancelEditBtn.addEventListener("click", () => {
      editUserModal.classList.add("hidden");
      userIdToEdit = null;
    });

    saveEditBtn.addEventListener("click", () => {
      saveUserEdit();
    });

    // Delete Confirmation
    cancelDeleteBtn.addEventListener("click", () => {
      deleteModal.classList.add("hidden");
      userIdToDelete = null;
    });

    confirmDeleteBtn.addEventListener("click", () => {
      if (userIdToDelete !== null) {
        deleteUser(userIdToDelete);
      }
    });

    // Settings Functions
    settingsBtn.addEventListener("click", () => {
      settingsModal.classList.remove("hidden");
    });

    cancelSettingsBtn.addEventListener("click", () => {
      settingsModal.classList.add("hidden");
    });

    saveSettingsBtn.addEventListener("click", () => {
      const theme = themeSelect.value;
      const language = languageSelect.value;

      // Apply theme
      if (theme === "dark") {
        document.body.classList.add("dark");
      } else {
        document.body.classList.remove("dark");
      }
      localStorage.setItem("theme", theme);

      // Apply language
      applyLanguage(language);
      localStorage.setItem("language", language);

      settingsModal.classList.add("hidden");
      Swal.fire({
        icon: "success",
        title: translations[language].success,
        text: translations[language].settings_saved
      });
    });

    // Logout Functions
    logoutBtn.addEventListener("click", () => {
      logoutModal.classList.remove("hidden");
    });

    cancelLogoutBtn.addEventListener("click", () => {
      logoutModal.classList.add("hidden");
    });

    confirmLogoutBtn.addEventListener("click", () => {
      fetch("/logout")
        .then(() => {
          localStorage.removeItem("theme");
          localStorage.removeItem("language");
          window.location.href = "/login";
        })
        .catch((error) => {
          console.error("Lỗi đăng xuất:", error);
          Swal.fire({
            icon: "error",
            title: translations[languageSelect.value || "vi"].error,
            text: translations[languageSelect.value || "vi"].logout_error
          });
        });
    });

    // Apply saved settings on page load
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.body.classList.add("dark");
      themeSelect.value = "dark";
    }

    const savedLanguage = localStorage.getItem("language");
    if (savedLanguage) {
      languageSelect.value = savedLanguage;
      applyLanguage(savedLanguage);
    } else {
      applyLanguage("vi");
    }

    // Initial fetch
    fetchUsers();
  </script>
</body>
</html>